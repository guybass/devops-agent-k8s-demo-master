# Development environment overlay - PORT FORWARDING MODE
# Skips ingress entirely - use kubectl port-forward to access services
#
# Deploy with: kubectl apply -k overlays/dev-port-forward/
#
# After deployment, access services with port-forward:
#   kubectl port-forward svc/dev-web-ui 3000:3000 -n devops-agent-demo
#   kubectl port-forward svc/dev-admin-dashboard 3001:3001 -n devops-agent-demo
#   kubectl port-forward svc/dev-api-gateway 8080:8080 -n devops-agent-demo
#
# Or access all three at once (run in separate terminals):
#   Terminal 1: kubectl port-forward svc/dev-web-ui 3000:3000 -n devops-agent-demo
#   Terminal 2: kubectl port-forward svc/dev-admin-dashboard 3001:3001 -n devops-agent-demo
#   Terminal 3: kubectl port-forward svc/dev-api-gateway 8080:8080 -n devops-agent-demo
#
# Then access:
#   - Web UI:          http://localhost:3000
#   - Admin Dashboard: http://localhost:3001
#   - API Gateway:     http://localhost:8080
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: devops-agent-demo

namePrefix: dev-
nameSuffix: ""

labels:
  - pairs:
      environment: development
      access-mode: port-forward
    includeSelectors: false

resources:
  - ../../base

patches:
  # DELETE all HPAs - not needed in dev environment with fixed replicas
  - target:
      kind: HorizontalPodAutoscaler
    patch: |
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: not-used

  # Reduce replicas for all deployments in dev
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      labelSelector: "app.kubernetes.io/part-of=devops-agent-demo"

  # Reduce resource requests/limits for dev
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "25m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "64Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "128Mi"
    target:
      kind: Deployment
      labelSelector: "app.kubernetes.io/component=frontend"

  # DELETE the ingress - not needed for port-forward mode
  - patch: |-
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: doesnt-matter
    target:
      kind: Ingress

  # Patch common-config for dev environment
  - patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: common-config
        namespace: devops-agent-demo
      data:
        ENVIRONMENT: "development"
        LOG_LEVEL: "DEBUG"
    target:
      kind: ConfigMap
      name: common-config

# Update image tags for development
images:
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-web-ui
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-admin-dashboard
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-api-gateway
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-auth-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-user-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-product-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-order-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-payment-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-notification-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-event-processor
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-analytics-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-report-generator
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-data-aggregator
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-image-processor
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-db-proxy
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-cache-manager
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-config-service
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-metrics-collector
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-queue-monitor
    newTag: dev
  - name: AWS_ACCOUNT_ID.dkr.ecr.AWS_REGION.amazonaws.com/devops-agent-demo-health-checker
    newTag: dev
