# ArgoCD Helm Values
# Configuration for ArgoCD deployment on EKS
#
# Key configurations:
#   - Server runs in insecure mode (TLS terminated at ALB)
#   - Kustomize build enabled for GitOps workflows
#   - Resource limits set for production stability
#   - HA disabled for pre-prod environment (enable for production)
---

# Global settings
global:
  logging:
    level: info

# ArgoCD Server configuration
server:
  # Run in insecure mode - TLS termination happens at ALB
  extraArgs:
    - --insecure

  # Resource allocation
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"

  # Security context
  containerSecurityContext:
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

# Repository Server configuration
repoServer:
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

  containerSecurityContext:
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

# Application Controller configuration
controller:
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

  containerSecurityContext:
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

# ApplicationSet Controller
applicationSet:
  enabled: true
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "128Mi"

# Notifications Controller
notifications:
  enabled: true
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "128Mi"

# Redis configuration
redis:
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "128Mi"

# Dex (OIDC provider) - disabled, using built-in auth
dex:
  enabled: false

# Config Management Plugins and Kustomize
configs:
  cm:
    # Enable Kustomize
    kustomize.buildOptions: "--enable-helm"

    # Application health checks
    resource.customizations.health.argoproj.io_Application: |
      hs = {}
      hs.status = "Progressing"
      hs.message = ""
      if obj.status ~= nil then
        if obj.status.health ~= nil then
          hs.status = obj.status.health.status
          if obj.status.health.message ~= nil then
            hs.message = obj.status.health.message
          end
        end
      end
      return hs

  # RBAC configuration
  rbac:
    policy.default: role:readonly
    policy.csv: |
      p, role:admin, applications, *, */*, allow
      p, role:admin, clusters, *, *, allow
      p, role:admin, repositories, *, *, allow
      p, role:admin, projects, *, *, allow
      g, admin, role:admin

  # Secret configuration - admin password will be auto-generated
  secret:
    createSecret: true
